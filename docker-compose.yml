services:
  postgres-master:
    image: bitnami/postgresql:latest
    user: "0"
    environment:
      - POSTGRESQL_REPLICATION_MODE=master
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_pass
      - POSTGRESQL_USERNAME=groceryuser
      - POSTGRESQL_PASSWORD=grocerypass
      - POSTGRESQL_DATABASE=grocerydb
      - POSTGRESQL_WAL_LEVEL=logical
      - POSTGRESQL_MAX_WAL_SENDERS=10
      - POSTGRESQL_MAX_REPLICATION_SLOTS=10
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U groceryuser -d grocerydb"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    volumes:
      - pgdata:/bitnami/postgresql
      - ./db/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"

  postgres-replica-1:
    image: bitnami/postgresql:latest
    user: "0"
    depends_on:
      postgres-master:
        condition: service_healthy
    environment:
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_PRIMARY_HOST=postgres-master
      - POSTGRESQL_PRIMARY_PORT_NUMBER=5432
      - POSTGRESQL_MASTER_HOST=postgres-master
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_pass
      - POSTGRESQL_USERNAME=groceryuser
      - POSTGRESQL_PASSWORD=grocerypass
      - POSTGRESQL_DATABASE=grocerydb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U groceryuser -d grocerydb"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    volumes:
      - pgdata_replica1:/bitnami/postgresql

  postgres-replica-2:
    image: bitnami/postgresql:latest
    user: "0"
    depends_on:
      postgres-master:
        condition: service_healthy
    environment:
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_PRIMARY_HOST=postgres-master
      - POSTGRESQL_PRIMARY_PORT_NUMBER=5432
      - POSTGRESQL_MASTER_HOST=postgres-master
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_pass
      - POSTGRESQL_USERNAME=groceryuser
      - POSTGRESQL_PASSWORD=grocerypass
      - POSTGRESQL_DATABASE=grocerydb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U groceryuser -d grocerydb"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    volumes:
      - pgdata_replica2:/bitnami/postgresql

  haproxy-read:
    image: haproxy:2.8
    depends_on:
      postgres-master:
        condition: service_healthy
      postgres-replica-1:
        condition: service_healthy
      postgres-replica-2:
        condition: service_healthy
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5439:5439"

  redis:
    image: redis:latest
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    depends_on:
      postgres-master:
        condition: service_healthy
      haproxy-read:
        condition: service_started
      redis:
        condition: service_started
    environment:
      DATABASE_URL_WRITE: postgresql+asyncpg://groceryuser:grocerypass@postgres-master:5432/grocerydb
      DATABASE_URL_READ: postgresql+asyncpg://groceryuser:grocerypass@haproxy-read:5439/grocerydb
      ES_URL: http://elasticsearch:9200
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
    ports:
      - "8000:8000"

  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - backend

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    command: >
      redpanda start \
        --overprovisioned \
        --smp 1 \
        --memory 512M \
        --reserve-memory 0M \
        --node-id 0 \
        --check=false \
        --kafka-addr PLAINTEXT://0.0.0.0:9092 \
        --advertise-kafka-addr PLAINTEXT://redpanda:9092
    ports:
      - "9092:9092"
      - "9644:9644"
    healthcheck:
      test: ["CMD-SHELL", "curl -s localhost:9644/v1/status/ready | grep -q 'ready' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  kafka-connect:
    image: debezium/connect:2.6
    depends_on:
      redpanda:
        condition: service_healthy
    environment:
      - BOOTSTRAP_SERVERS=redpanda:9092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=connect-configs
      - OFFSET_STORAGE_TOPIC=connect-offsets
      - STATUS_STORAGE_TOPIC=connect-status
      - CONFIG_STORAGE_REPLICATION_FACTOR=1
      - OFFSET_STORAGE_REPLICATION_FACTOR=1
      - STATUS_STORAGE_REPLICATION_FACTOR=1
      - KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - CONNECT_REST_ADVERTISED_HOST_NAME=kafka-connect
      - CONNECT_PLUGIN_PATH=/kafka/connect,/usr/share/java
    ports:
      - "8083:8083"
    volumes:
      - ./connect/connectors:/kafka/connectors
      - ./connect/plugins:/kafka/connect

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.3
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q green || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.3
    depends_on:
      - elasticsearch
    environment:
      - ELASTICSEARCH_HOSTS=["http://elasticsearch:9200"]
    ports:
      - "5601:5601"

volumes:
  pgdata:
  pgdata_replica1:
  pgdata_replica2:
